name: "🌟 Thetah Advanced Deployment System"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"

jobs:
  deploy-thetah:
    name: "🚀 Launch Thetah Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      SECRET_TOKEN: ${{ secrets.SECRET_TOKEN }}
      NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "thetah.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: 🎯 System Configuration
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "╔═══════════════════════════════════════════════════╗" -ForegroundColor Cyan
          Write-Host "║              THETAH DEPLOYMENT MATRIX            ║" -ForegroundColor Cyan
          Write-Host "╠═══════════════════════════════════════════════════╣" -ForegroundColor Cyan
          Write-Host "║ ⚡ Active Instance    : $env:INSTANCE_ID                            ║" -ForegroundColor Green
          Write-Host "║ 🔄 Previous Instance : $prevInstance                            ║" -ForegroundColor Yellow
          Write-Host "║ 📍 Repository        : $env:REPO" -ForegroundColor Magenta
          Write-Host "║ 🔧 Workflow Engine   : $env:WORKFLOW_FILE                  ║" -ForegroundColor Blue
          Write-Host "║ 🆔 Deployment Hash   : $env:DEPLOYMENT_ID" -ForegroundColor Red
          Write-Host "╚═══════════════════════════════════════════════════╝" -ForegroundColor Cyan

      - name: 🔒 Authentication Protocol
        shell: pwsh
        run: |
          Write-Host "┌─────────────────────────────────────┐" -ForegroundColor DarkCyan
          Write-Host "│       CREDENTIAL VERIFICATION      │" -ForegroundColor DarkCyan
          Write-Host "└─────────────────────────────────────┘" -ForegroundColor DarkCyan
          if (-not $env:SECRET_TOKEN) {
            Write-Host "❌ CRITICAL: Missing GitHub Secret: SECRET_TOKEN" -ForegroundColor Red
            exit 1
          }
          if (-not $env:NGROK_TOKEN) {
            Write-Host "❌ CRITICAL: Missing Ngrok Auth Token: NGROK_TOKEN" -ForegroundColor Red
            exit 1
          }
          Write-Host "✅ Security tokens validated - ACCESS GRANTED" -ForegroundColor Green

      - name: 📦 Resource Acquisition
        shell: pwsh
        run: |
          $url = "https://gitlab.com/brianmayaka90/thetah/-/raw/main/Thetah-instance.ps1"
          Write-Host "╭─────────────────────────────────────╮" -ForegroundColor Magenta
          Write-Host "│      THETAH CORE ACQUISITION       │" -ForegroundColor Magenta
          Write-Host "╰─────────────────────────────────────╯" -ForegroundColor Magenta
          Write-Host "🌐 Fetching Thetah-instance.ps1..." -ForegroundColor Cyan
          Invoke-WebRequest -Uri $url -OutFile "Thetah-instance.ps1" -UseBasicParsing
          if (!(Test-Path "./Thetah-instance.ps1")) {
            Write-Host "❌ FATAL: Failed to acquire Thetah-instance.ps1" -ForegroundColor Red
            exit 1
          }
          Write-Host "✅ Thetah core module acquired successfully" -ForegroundColor Green

      - name: ⚡ Thetah Core Execution
        shell: pwsh
        run: |
          Write-Host "╔═════════════════════════════════════════════════════╗" -ForegroundColor Yellow
          Write-Host "║                THETAH CORE IGNITION                ║" -ForegroundColor Yellow
          Write-Host "╚═════════════════════════════════════════════════════╝" -ForegroundColor Yellow
          Write-Host "🔥 Initializing Thetah-instance.ps1..." -ForegroundColor Red
          powershell.exe -ExecutionPolicy Bypass -File ".\Thetah-instance.ps1"

      - name: 🏆 Mission Status Report
        if: always()
        shell: pwsh
        run: |
          Write-Host "╔═══════════════════════════════════════════════════════╗" -ForegroundColor Green
          Write-Host "║                DEPLOYMENT COMPLETED                  ║" -ForegroundColor Green
          Write-Host "╠═══════════════════════════════════════════════════════╣" -ForegroundColor Green
          Write-Host "║ ✅ Thetah Instance $env:INSTANCE_ID - MISSION ACCOMPLISHED    ║" -ForegroundColor White
          Write-Host "║ 🔋 System Status: OPERATIONAL                        ║" -ForegroundColor White
          Write-Host "║ 🎯 Deployment executed with precision                ║" -ForegroundColor White
          Write-Host "╚═══════════════════════════════════════════════════════╝" -ForegroundColor Green
